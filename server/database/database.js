import pg from 'pg';
import sqlite3 from 'sqlite3';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import winston from 'winston';

const { Pool } = pg;
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// –õ–æ–≥–≥–µ—Ä –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
const dbLogger = winston.createLogger({
    level: 'info',
    format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.json()
    ),
    transports: [
        new winston.transports.Console({
            format: winston.format.combine(
                winston.format.colorize(),
                winston.format.simple()
            )
        })
    ]
});

class DatabaseManager {
    constructor() {
        this.isProduction = process.env.NODE_ENV === 'production';
        this.db = null;
        this.initialized = false;
    }

    async init() {
        try {
            if (this.isProduction) {
                await this.initPostgreSQL();
            } else {
                await this.initSQLite();
            }
            
            await this.createTables();
            this.initialized = true;
            dbLogger.info('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        } catch (error) {
            dbLogger.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', error);
            throw error;
        }
    }

    async initPostgreSQL() {
        const connectionString = process.env.DATABASE_URL || 
            `postgresql://${process.env.DB_USER}:${process.env.DB_PASSWORD}@${process.env.DB_HOST}:${process.env.DB_PORT}/${process.env.DB_NAME}`;

        this.db = new Pool({
            connectionString,
            ssl: process.env.DB_SSL === 'true' ? { rejectUnauthorized: false } : false,
            max: 20,
            idleTimeoutMillis: 30000,
            connectionTimeoutMillis: 2000,
        });

        // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        const client = await this.db.connect();
        await client.query('SELECT NOW()');
        client.release();
        
        dbLogger.info('üêò PostgreSQL –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ');
    }

    async initSQLite() {
        const dbPath = join(__dirname, '../../data/dilauncher.db');
        
        this.db = new sqlite3.Database(dbPath, (err) => {
            if (err) {
                dbLogger.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ SQLite:', err);
                throw err;
            }
            dbLogger.info('üìÑ SQLite –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ');
        });

        // –í–∫–ª—é—á–∞–µ–º WAL —Ä–µ–∂–∏–º –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        await this.query('PRAGMA journal_mode = WAL;');
        await this.query('PRAGMA synchronous = NORMAL;');
        await this.query('PRAGMA cache_size = 1000;');
        await this.query('PRAGMA foreign_keys = ON;');
    }

    async query(text, params = []) {
        if (!this.initialized && !text.includes('CREATE TABLE') && !text.includes('PRAGMA')) {
            throw new Error('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        }

        if (this.isProduction) {
            // PostgreSQL
            const client = await this.db.connect();
            try {
                const result = await client.query(text, params);
                return result;
            } finally {
                client.release();
            }
        } else {
            // SQLite
            return new Promise((resolve, reject) => {
                this.db.all(text, params, (err, rows) => {
                    if (err) {
                        reject(err);
                    } else {
                        resolve({ rows, rowCount: rows?.length || 0 });
                    }
                });
            });
        }
    }

    async run(text, params = []) {
        if (this.isProduction) {
            const client = await this.db.connect();
            try {
                const result = await client.query(text, params);
                return result;
            } finally {
                client.release();
            }
        } else {
            return new Promise((resolve, reject) => {
                this.db.run(text, params, function(err) {
                    if (err) {
                        reject(err);
                    } else {
                        resolve({ 
                            lastID: this.lastID, 
                            changes: this.changes,
                            rowCount: this.changes 
                        });
                    }
                });
            });
        }
    }

    async createTables() {
        const tables = [
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            `CREATE TABLE IF NOT EXISTS users (
                id ${this.isProduction ? 'SERIAL PRIMARY KEY' : 'INTEGER PRIMARY KEY AUTOINCREMENT'},
                username VARCHAR(50) UNIQUE NOT NULL,
                email VARCHAR(100) UNIQUE NOT NULL,
                password_hash VARCHAR(255),
                display_name VARCHAR(100),
                avatar_url VARCHAR(255),
                email_verified BOOLEAN DEFAULT FALSE,
                two_factor_enabled BOOLEAN DEFAULT FALSE,
                two_factor_secret VARCHAR(255),
                google_id VARCHAR(255) UNIQUE,
                discord_id VARCHAR(255) UNIQUE,
                subscription_type VARCHAR(20) DEFAULT 'free',
                subscription_expires_at TIMESTAMP,
                created_at TIMESTAMP DEFAULT ${this.isProduction ? 'CURRENT_TIMESTAMP' : 'CURRENT_TIMESTAMP'},
                updated_at TIMESTAMP DEFAULT ${this.isProduction ? 'CURRENT_TIMESTAMP' : 'CURRENT_TIMESTAMP'},
                last_login_at TIMESTAMP,
                is_online BOOLEAN DEFAULT FALSE,
                total_playtime INTEGER DEFAULT 0,
                preferences JSONB${this.isProduction ? '' : 'TEXT'},
                status VARCHAR(20) DEFAULT 'active'
            )`,

            // Refresh —Ç–æ–∫–µ–Ω—ã
            `CREATE TABLE IF NOT EXISTS refresh_tokens (
                id ${this.isProduction ? 'SERIAL PRIMARY KEY' : 'INTEGER PRIMARY KEY AUTOINCREMENT'},
                user_id INTEGER NOT NULL,
                token VARCHAR(255) UNIQUE NOT NULL,
                expires_at TIMESTAMP NOT NULL,
                created_at TIMESTAMP DEFAULT ${this.isProduction ? 'CURRENT_TIMESTAMP' : 'CURRENT_TIMESTAMP'},
                device_info JSONB${this.isProduction ? '' : 'TEXT'},
                is_revoked BOOLEAN DEFAULT FALSE,
                FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
            )`,

            // –ü—Ä–æ—Ñ–∏–ª–∏ –ª–∞—É–Ω—á–µ—Ä–∞
            `CREATE TABLE IF NOT EXISTS launcher_profiles (
                id ${this.isProduction ? 'SERIAL PRIMARY KEY' : 'INTEGER PRIMARY KEY AUTOINCREMENT'},
                user_id INTEGER NOT NULL,
                name VARCHAR(100) NOT NULL,
                description TEXT,
                minecraft_version VARCHAR(20) NOT NULL,
                mod_loader VARCHAR(20), -- 'forge', 'fabric', 'quilt', 'vanilla'
                mod_loader_version VARCHAR(50),
                java_version VARCHAR(20),
                memory_allocation INTEGER DEFAULT 2048,
                jvm_args TEXT,
                icon_url VARCHAR(255),
                created_at TIMESTAMP DEFAULT ${this.isProduction ? 'CURRENT_TIMESTAMP' : 'CURRENT_TIMESTAMP'},
                updated_at TIMESTAMP DEFAULT ${this.isProduction ? 'CURRENT_TIMESTAMP' : 'CURRENT_TIMESTAMP'},
                last_played_at TIMESTAMP,
                playtime INTEGER DEFAULT 0,
                is_active BOOLEAN DEFAULT TRUE,
                settings JSONB${this.isProduction ? '' : 'TEXT'},
                FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
            )`,

            // –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–æ–¥—ã
            `CREATE TABLE IF NOT EXISTS installed_mods (
                id ${this.isProduction ? 'SERIAL PRIMARY KEY' : 'INTEGER PRIMARY KEY AUTOINCREMENT'},
                profile_id INTEGER NOT NULL,
                mod_id VARCHAR(255) NOT NULL, -- ID –∏–∑ CurseForge/Modrinth
                mod_name VARCHAR(255) NOT NULL,
                mod_version VARCHAR(100),
                mod_source VARCHAR(20), -- 'curseforge', 'modrinth', 'manual'
                file_name VARCHAR(255),
                file_size INTEGER,
                download_url VARCHAR(500),
                dependencies JSONB${this.isProduction ? '' : 'TEXT'},
                installed_at TIMESTAMP DEFAULT ${this.isProduction ? 'CURRENT_TIMESTAMP' : 'CURRENT_TIMESTAMP'},
                is_enabled BOOLEAN DEFAULT TRUE,
                FOREIGN KEY (profile_id) REFERENCES launcher_profiles (id) ON DELETE CASCADE
            )`,

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã
            `CREATE TABLE IF NOT EXISTS saved_servers (
                id ${this.isProduction ? 'SERIAL PRIMARY KEY' : 'INTEGER PRIMARY KEY AUTOINCREMENT'},
                user_id INTEGER NOT NULL,
                name VARCHAR(100) NOT NULL,
                address VARCHAR(255) NOT NULL,
                port INTEGER DEFAULT 25565,
                version VARCHAR(20),
                motd TEXT,
                favicon_url VARCHAR(255),
                player_count INTEGER DEFAULT 0,
                max_players INTEGER DEFAULT 0,
                ping INTEGER,
                is_online BOOLEAN DEFAULT FALSE,
                last_checked_at TIMESTAMP,
                added_at TIMESTAMP DEFAULT ${this.isProduction ? 'CURRENT_TIMESTAMP' : 'CURRENT_TIMESTAMP'},
                is_favorite BOOLEAN DEFAULT FALSE,
                tags JSONB${this.isProduction ? '' : 'TEXT'},
                FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
            )`,

            // –û–±–ª–∞—á–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            `CREATE TABLE IF NOT EXISTS cloud_saves (
                id ${this.isProduction ? 'SERIAL PRIMARY KEY' : 'INTEGER PRIMARY KEY AUTOINCREMENT'},
                user_id INTEGER NOT NULL,
                profile_id INTEGER NOT NULL,
                world_name VARCHAR(255) NOT NULL,
                file_path VARCHAR(500),
                file_size INTEGER,
                file_hash VARCHAR(64),
                uploaded_at TIMESTAMP DEFAULT ${this.isProduction ? 'CURRENT_TIMESTAMP' : 'CURRENT_TIMESTAMP'},
                is_latest BOOLEAN DEFAULT TRUE,
                version INTEGER DEFAULT 1,
                FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE,
                FOREIGN KEY (profile_id) REFERENCES launcher_profiles (id) ON DELETE CASCADE
            )`,

            // –õ–æ–≥ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            `CREATE TABLE IF NOT EXISTS user_actions (
                id ${this.isProduction ? 'SERIAL PRIMARY KEY' : 'INTEGER PRIMARY KEY AUTOINCREMENT'},
                user_id INTEGER,
                action_type VARCHAR(50) NOT NULL,
                details JSONB${this.isProduction ? '' : 'TEXT'},
                ip_address INET${this.isProduction ? '' : 'TEXT'},
                user_agent TEXT,
                created_at TIMESTAMP DEFAULT ${this.isProduction ? 'CURRENT_TIMESTAMP' : 'CURRENT_TIMESTAMP'},
                FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE SET NULL
            )`
        ];

        for (const table of tables) {
            try {
                await this.run(table);
                dbLogger.info(`‚úÖ –¢–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞/–ø—Ä–æ–≤–µ—Ä–µ–Ω–∞`);
            } catch (error) {
                dbLogger.error(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã:`, error);
                throw error;
            }
        }

        // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        await this.createIndexes();
    }

    async createIndexes() {
        const indexes = [
            'CREATE INDEX IF NOT EXISTS idx_users_email ON users(email)',
            'CREATE INDEX IF NOT EXISTS idx_users_username ON users(username)',
            'CREATE INDEX IF NOT EXISTS idx_refresh_tokens_token ON refresh_tokens(token)',
            'CREATE INDEX IF NOT EXISTS idx_refresh_tokens_user_id ON refresh_tokens(user_id)',
            'CREATE INDEX IF NOT EXISTS idx_profiles_user_id ON launcher_profiles(user_id)',
            'CREATE INDEX IF NOT EXISTS idx_mods_profile_id ON installed_mods(profile_id)',
            'CREATE INDEX IF NOT EXISTS idx_servers_user_id ON saved_servers(user_id)',
            'CREATE INDEX IF NOT EXISTS idx_saves_user_id ON cloud_saves(user_id)',
            'CREATE INDEX IF NOT EXISTS idx_actions_user_id ON user_actions(user_id)',
            'CREATE INDEX IF NOT EXISTS idx_actions_created_at ON user_actions(created_at)'
        ];

        for (const index of indexes) {
            try {
                await this.run(index);
            } catch (error) {
                // –ò–Ω–¥–µ–∫—Å –º–æ–∂–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
                if (!error.message.includes('already exists')) {
                    dbLogger.warn(`‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–¥–µ–∫—Å–∞:`, error.message);
                }
            }
        }
    }

    async close() {
        if (this.db) {
            if (this.isProduction) {
                await this.db.end();
            } else {
                this.db.close();
            }
            dbLogger.info('üîí –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç–æ');
        }
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
    async transaction(callback) {
        if (this.isProduction) {
            const client = await this.db.connect();
            try {
                await client.query('BEGIN');
                const result = await callback(client);
                await client.query('COMMIT');
                return result;
            } catch (error) {
                await client.query('ROLLBACK');
                throw error;
            } finally {
                client.release();
            }
        } else {
            // SQLite –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ —Ç–æ–º –∂–µ –æ–±—ä–µ–º–µ
            return new Promise((resolve, reject) => {
                this.db.serialize(() => {
                    this.db.run('BEGIN TRANSACTION');
                    callback(this.db)
                        .then(result => {
                            this.db.run('COMMIT', (err) => {
                                if (err) reject(err);
                                else resolve(result);
                            });
                        })
                        .catch(error => {
                            this.db.run('ROLLBACK');
                            reject(error);
                        });
                });
            });
        }
    }
}

// –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
const database = new DatabaseManager();

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–µ—Ç–æ–¥—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
export const initDatabase = () => database.init();
export const query = (text, params) => database.query(text, params);
export const run = (text, params) => database.run(text, params);
export const transaction = (callback) => database.transaction(callback);
export const closeDatabase = () => database.close();

export default database; 